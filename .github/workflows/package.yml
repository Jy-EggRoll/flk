name: Package Development Release

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+.dev.[0-9]+" # åŒ¹é… x.y.z.dev.n æ ¼å¼çš„å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

permissions:
    contents: write

jobs:
    package:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.26.0'

            - name: Get version info
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    # æ‰‹åŠ¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬æ ‡è¯†
                    VERSION="dev-$(date +%Y%m%d-%H%M%S)"
                    echo "Manual run - using timestamp version: $VERSION"
                  else
                    # Tag è§¦å‘æ—¶ï¼Œä» tag è·å–ç‰ˆæœ¬
                    VERSION=${GITHUB_REF#refs/tags/}
                    echo "Tag triggered - using tag version: $VERSION"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Build binaries for all platforms
              run: |
                  # åˆ›å»ºè¾“å‡ºç›®å½•
                  mkdir -p build

                  echo "========================================"
                  echo "å¼€å§‹äº¤å‰ç¼–è¯‘ Go äºŒè¿›åˆ¶æ–‡ä»¶"
                  echo "========================================"
                  echo ""

                  # Windows
                  echo "[1/33] ç¼–è¯‘ Windows 386..."
                  GOOS=windows GOARCH=386 go build -ldflags="-s -w" -o build/flk-windows-386.exe
                  echo "å®Œæˆ"

                  echo "[2/33] ç¼–è¯‘ Windows amd64..."
                  GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-windows-amd64.exe
                  echo "å®Œæˆ"

                  echo "[3/33] ç¼–è¯‘ Windows arm..."
                  GOOS=windows GOARCH=arm go build -ldflags="-s -w" -o build/flk-windows-arm.exe
                  echo "å®Œæˆ"

                  echo "[4/33] ç¼–è¯‘ Windows arm64..."
                  GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-windows-arm64.exe
                  echo "å®Œæˆ"

                  # Linux
                  echo ""
                  echo "[5/33] ç¼–è¯‘ Linux 386..."
                  GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o build/flk-linux-386
                  echo "å®Œæˆ"

                  echo "[6/33] ç¼–è¯‘ Linux amd64..."
                  GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-linux-amd64
                  echo "å®Œæˆ"

                  echo "[7/33] ç¼–è¯‘ Linux arm..."
                  GOOS=linux GOARCH=arm go build -ldflags="-s -w" -o build/flk-linux-arm
                  echo "å®Œæˆ"

                  echo "[8/33] ç¼–è¯‘ Linux arm64..."
                  GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-linux-arm64
                  echo "å®Œæˆ"

                  echo "[9/33] ç¼–è¯‘ Linux mips..."
                  GOOS=linux GOARCH=mips go build -ldflags="-s -w" -o build/flk-linux-mips
                  echo "å®Œæˆ"

                  echo "[10/33] ç¼–è¯‘ Linux mipsle..."
                  GOOS=linux GOARCH=mipsle go build -ldflags="-s -w" -o build/flk-linux-mipsle
                  echo "å®Œæˆ"

                  echo "[11/33] ç¼–è¯‘ Linux mips64..."
                  GOOS=linux GOARCH=mips64 go build -ldflags="-s -w" -o build/flk-linux-mips64
                  echo "å®Œæˆ"

                  echo "[12/33] ç¼–è¯‘ Linux mips64le..."
                  GOOS=linux GOARCH=mips64le go build -ldflags="-s -w" -o build/flk-linux-mips64le
                  echo "å®Œæˆ"

                  echo "[13/33] ç¼–è¯‘ Linux ppc64..."
                  GOOS=linux GOARCH=ppc64 go build -ldflags="-s -w" -o build/flk-linux-ppc64
                  echo "å®Œæˆ"

                  echo "[14/33] ç¼–è¯‘ Linux ppc64le..."
                  GOOS=linux GOARCH=ppc64le go build -ldflags="-s -w" -o build/flk-linux-ppc64le
                  echo "å®Œæˆ"

                  echo "[15/33] ç¼–è¯‘ Linux riscv64..."
                  GOOS=linux GOARCH=riscv64 go build -ldflags="-s -w" -o build/flk-linux-riscv64
                  echo "å®Œæˆ"

                  echo "[16/33] ç¼–è¯‘ Linux s390x..."
                  GOOS=linux GOARCH=s390x go build -ldflags="-s -w" -o build/flk-linux-s390x
                  echo "å®Œæˆ"

                  # macOS (Darwin)
                  echo ""
                  echo "[17/33] ç¼–è¯‘ macOS amd64..."
                  GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-darwin-amd64
                  echo "å®Œæˆ"

                  echo "[18/33] ç¼–è¯‘ macOS arm64 (Apple Silicon)..."
                  GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-darwin-arm64
                  echo "å®Œæˆ"

                  # FreeBSD
                  echo ""
                  echo "[19/33] ç¼–è¯‘ FreeBSD 386..."
                  GOOS=freebsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-freebsd-386
                  echo "å®Œæˆ"

                  echo "[20/33] ç¼–è¯‘ FreeBSD amd64..."
                  GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-freebsd-amd64
                  echo "å®Œæˆ"

                  echo "[21/33] ç¼–è¯‘ FreeBSD arm..."
                  GOOS=freebsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-freebsd-arm
                  echo "å®Œæˆ"

                  echo "[22/33] ç¼–è¯‘ FreeBSD arm64..."
                  GOOS=freebsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-freebsd-arm64
                  echo "å®Œæˆ"

                  # OpenBSD
                  echo ""
                  echo "[23/33] ç¼–è¯‘ OpenBSD 386..."
                  GOOS=openbsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-openbsd-386
                  echo "å®Œæˆ"

                  echo "[24/33] ç¼–è¯‘ OpenBSD amd64..."
                  GOOS=openbsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-openbsd-amd64
                  echo "å®Œæˆ"

                  echo "[25/33] ç¼–è¯‘ OpenBSD arm..."
                  GOOS=openbsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-openbsd-arm
                  echo "å®Œæˆ"

                  echo "[26/33] ç¼–è¯‘ OpenBSD arm64..."
                  GOOS=openbsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-openbsd-arm64
                  echo "å®Œæˆ"

                  # NetBSD
                  echo ""
                  echo "[27/33] ç¼–è¯‘ NetBSD 386..."
                  GOOS=netbsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-netbsd-386
                  echo "å®Œæˆ"

                  echo "[28/33] ç¼–è¯‘ NetBSD amd64..."
                  GOOS=netbsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-netbsd-amd64
                  echo "å®Œæˆ"

                  echo "[29/33] ç¼–è¯‘ NetBSD arm..."
                  GOOS=netbsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-netbsd-arm
                  echo "å®Œæˆ"

                  echo "[30/33] ç¼–è¯‘ NetBSD arm64..."
                  GOOS=netbsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-netbsd-arm64
                  echo "å®Œæˆ"

                  # DragonFly BSD
                  echo ""
                  echo "[31/33] ç¼–è¯‘ DragonFly BSD amd64..."
                  GOOS=dragonfly GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-dragonfly-amd64
                  echo "å®Œæˆ"

                  # Solaris
                  echo ""
                  echo "[32/33] ç¼–è¯‘ Solaris amd64..."
                  GOOS=solaris GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-solaris-amd64
                  echo "å®Œæˆ"

                  # AIX
                  echo ""
                  echo "[33/33] ç¼–è¯‘ AIX ppc64..."
                  GOOS=aix GOARCH=ppc64 go build -ldflags="-s -w" -o build/flk-aix-ppc64
                  echo "å®Œæˆ"

                  # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
                  echo ""
                  echo "========================================"
                  echo "ç¼–è¯‘å®Œæˆï¼ç»Ÿè®¡ä¿¡æ¯ï¼š"
                  echo "========================================"
                  echo "æ€»æ–‡ä»¶æ•°: $(ls -1 build/ | wc -l)"
                  echo "æ€»å¤§å°: $(du -sh build/ | cut -f1)"

            - name: Create development release (for tag runs only)
              if: github.event_name != 'workflow_dispatch'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  name: "flk v${{ steps.get_version.outputs.version }} (å¼€å‘ç‰ˆ)"
                  body: |
                      # ğŸš§ å¼€å‘ç‰ˆæœ¬ - ä»…ä¾›æµ‹è¯•

                      è¿™æ˜¯ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½åŒ…å«ä¸ç¨³å®šæˆ–å®éªŒæ€§åŠŸèƒ½ã€‚

                      ## ğŸ“¥ å¿«é€Ÿä¸‹è½½

                      | æ¶æ„ | Windows | Linux | macOS | FreeBSD | OpenBSD | NetBSD | å…¶ä»– |
                      |------|---------|-------|-------|---------|---------|--------|------|
                      | **x64** | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-amd64.exe) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-darwin-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-openbsd-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-netbsd-amd64) | [Solaris](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-solaris-amd64) |
                      | **ARM64** | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-arm64.exe) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-darwin-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-openbsd-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-netbsd-arm64) | ä¸æ”¯æŒ |
                      | **x86** | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-386.exe) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-386) | ä¸æ”¯æŒ | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-386) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-openbsd-386) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-netbsd-386) | ä¸æ”¯æŒ |
                      | **ARM** | [arm](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-arm.exe) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-arm) | ä¸æ”¯æŒ | [arm](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-arm) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-openbsd-arm) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-netbsd-arm) | ä¸æ”¯æŒ |
                      | **MIPS** | ä¸æ”¯æŒ | [mips](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-mips) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **MIPSle** | ä¸æ”¯æŒ | [mipsle](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-mipsle) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **MIPS64** | ä¸æ”¯æŒ | [mips64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-mips64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **MIPS64le** | ä¸æ”¯æŒ | [mips64le](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-mips64le) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **PPC64** | ä¸æ”¯æŒ | [ppc64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-ppc64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | [AIX](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-aix-ppc64) |
                      | **PPC64le** | ä¸æ”¯æŒ | [ppc64le](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-ppc64le) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **RISC-V 64** | ä¸æ”¯æŒ | [riscv64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-riscv64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **S390X** | ä¸æ”¯æŒ | [s390x](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-s390x) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | [DragonFly](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-dragonfly-amd64) |

                      > ğŸ’¡ **æç¤º**ï¼šWindows ç”¨æˆ·ä¸‹è½½ `.exe` æ–‡ä»¶ï¼Œå…¶ä»–ç³»ç»Ÿä¸‹è½½åéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ `chmod +x flk-*`

                      ---

                      ## ç‰ˆæœ¬ä¿¡æ¯

                      - ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}
                      - æ„å»ºæ—¶é—´: ${{ github.run_id }}
                      - æäº¤: ${{ github.sha }}

                      ## æ³¨æ„äº‹é¡¹

                      âš ï¸ ä»…é€šè¿‡ GitHub Release æä¾›ä¸‹è½½
                      âš ï¸ å¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½

                      ---

                      ğŸ“¦ **å®‰è£…æ–¹å¼ï¼š** ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œèµ‹äºˆæ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
                  files: |
                      build/*
                  draft: false
                  prerelease: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: binaries-${{ steps.get_version.outputs.version }}
                  path: build/*
                  retention-days: 30
