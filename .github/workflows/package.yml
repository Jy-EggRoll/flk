name: Package Development Release

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+.dev.[0-9]+" # åŒ¹é… x.y.z.dev.n æ ¼å¼çš„å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

permissions:
    contents: write

jobs:
    package:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.26.0"

            - name: Get version info
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    # æ‰‹åŠ¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬æ ‡è¯†
                    VERSION="dev-$(date +%Y%m%d-%H%M%S)"
                    echo "Manual run - using timestamp version: $VERSION"
                  else
                    # Tag è§¦å‘æ—¶ï¼Œä» tag è·å–ç‰ˆæœ¬
                    VERSION=${GITHUB_REF#refs/tags/}
                    echo "Tag triggered - using tag version: $VERSION"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Build binaries for common platforms
              run: |
                  # åˆ›å»ºè¾“å‡ºç›®å½•
                  mkdir -p build

                  echo "========================================"
                  echo "å¼€å§‹äº¤å‰ç¼–è¯‘ Go äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä»…å¸¸ç”¨å¹³å°ï¼‰"
                  echo "========================================"
                  echo ""

                  # Windows (å¸¸ç”¨æ¶æ„)
                  echo "[1/10] ç¼–è¯‘ Windows x86 (386)..."
                  GOOS=windows GOARCH=386 go build -ldflags="-s -w" -o build/flk-windows-386.exe
                  echo "å®Œæˆ"

                  echo "[2/10] ç¼–è¯‘ Windows x64 (amd64)..."
                  GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-windows-amd64.exe
                  echo "å®Œæˆ"

                  echo "[3/10] ç¼–è¯‘ Windows ARM64..."
                  GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-windows-arm64.exe
                  echo "å®Œæˆ"

                  # Linux (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[4/10] ç¼–è¯‘ Linux x86 (386)..."
                  GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o build/flk-linux-386
                  echo "å®Œæˆ"

                  echo "[5/10] ç¼–è¯‘ Linux x64 (amd64)..."
                  GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-linux-amd64
                  echo "å®Œæˆ"

                  echo "[6/10] ç¼–è¯‘ Linux ARM (armv7)..."
                  GOOS=linux GOARCH=arm go build -ldflags="-s -w" -o build/flk-linux-arm
                  echo "å®Œæˆ"

                  echo "[7/10] ç¼–è¯‘ Linux ARM64..."
                  GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-linux-arm64
                  echo "å®Œæˆ"

                  # macOS (Darwin) (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[8/10] ç¼–è¯‘ macOS x64 (amd64)..."
                  GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-darwin-amd64
                  echo "å®Œæˆ"

                  echo "[9/10] ç¼–è¯‘ macOS ARM64 (Apple Silicon)..."
                  GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-darwin-arm64
                  echo "å®Œæˆ"

                  # FreeBSD (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[10/10] ç¼–è¯‘ FreeBSD x64 (amd64)..."
                  GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-freebsd-amd64
                  echo "å®Œæˆ"

                  echo "[11/11] ç¼–è¯‘ FreeBSD ARM64..."
                  GOOS=freebsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-freebsd-arm64
                  echo "å®Œæˆ"

                  # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
                  echo ""
                  echo "========================================"
                  echo "ç¼–è¯‘å®Œæˆï¼ç»Ÿè®¡ä¿¡æ¯ï¼š"
                  echo "========================================"
                  echo "æ€»æ–‡ä»¶æ•°: $(ls -1 build/ | wc -l)"
                  echo "æ€»å¤§å°: $(du -sh build/ | cut -f1)"

            - name: Create development release (for tag runs only)
              if: github.event_name != 'workflow_dispatch'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  name: "flk v${{ steps.get_version.outputs.version }} (å¼€å‘ç‰ˆ)"
                  body: |
                      # ğŸš§ å¼€å‘ç‰ˆæœ¬ - ä»…ä¾›æµ‹è¯•

                      è¿™æ˜¯ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½åŒ…å«ä¸ç¨³å®šæˆ–å®éªŒæ€§åŠŸèƒ½ã€‚

                      ## ğŸ“¥ å¿«é€Ÿä¸‹è½½

                      | æ¶æ„ | Windows | Linux | macOS | FreeBSD |
                      |------|---------|-------|-------|---------|
                      | **x86 (32ä½)** | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-386.exe) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-386) | ä¸æ”¯æŒ | ä¸æ”¯æŒ |
                      | **x64 (64ä½)** | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-amd64.exe) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-darwin-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-amd64) |
                      | **ARM64** | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-windows-arm64.exe) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-arm64) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-darwin-arm64) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-freebsd-arm64) |
                      | **ARM (armv7)** | ä¸æ”¯æŒ | [ARM](https://github.com/Jy-EggRoll/flk/releases/download/${{ steps.get_version.outputs.version }}/flk-linux-arm) | ä¸æ”¯æŒ | ä¸æ”¯æŒ |

                      > ğŸ’¡ **æç¤º**ï¼šWindows ç”¨æˆ·ä¸‹è½½ `.exe` æ–‡ä»¶ï¼Œå…¶ä»–ç³»ç»Ÿä¸‹è½½åéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ `chmod +x flk-*`

                      ---

                      ## ç‰ˆæœ¬ä¿¡æ¯

                      - ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}
                      - æ„å»ºæ—¶é—´: ${{ github.run_id }}
                      - æäº¤: ${{ github.sha }}

                      ## æ³¨æ„äº‹é¡¹

                      âš ï¸ ä»…é€šè¿‡ GitHub Release æä¾›ä¸‹è½½
                      âš ï¸ å¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½

                      ---

                      ğŸ“¦ **å®‰è£…æ–¹å¼ï¼š** ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œèµ‹äºˆæ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
                  files: |
                      build/*
                  draft: false
                  prerelease: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: binaries-${{ steps.get_version.outputs.version }}
                  path: build/*
                  retention-days: 30
