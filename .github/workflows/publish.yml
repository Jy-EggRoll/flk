# è¯¥å·¥ä½œæµåªèƒ½é€šè¿‡æ­£å¼ç‰ˆæœ¬çš„æ ‡ç­¾è‡ªåŠ¨è§¦å‘

name: Publish Release

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+" # åŒ¹é… x.y.z æ ¼å¼çš„æ­£å¼ç‰ˆæœ¬æ ‡ç­¾

permissions:
    contents: write

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.26.0"

            - name: Get tag version
              id: get_version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION"

            - name: Build binaries for common platforms
              run: |
                  # åˆ›å»ºè¾“å‡ºç›®å½•
                  mkdir -p build

                  echo "========================================"
                  echo "å¼€å§‹äº¤å‰ç¼–è¯‘ Go äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä»…å¸¸ç”¨å¹³å°ï¼‰"
                  echo "========================================"
                  echo ""

                  # Windows (å¸¸ç”¨æ¶æ„)
                  echo "[1/11] ç¼–è¯‘ Windows x86 (386)..."
                  GOOS=windows GOARCH=386 go build -ldflags="-s -w" -o build/flk-windows-386.exe
                  echo "å®Œæˆ"

                  echo "[2/11] ç¼–è¯‘ Windows x64 (amd64)..."
                  GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-windows-amd64.exe
                  echo "å®Œæˆ"

                  echo "[3/11] ç¼–è¯‘ Windows ARM64..."
                  GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-windows-arm64.exe
                  echo "å®Œæˆ"

                  # Linux (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[4/11] ç¼–è¯‘ Linux x86 (386)..."
                  GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o build/flk-linux-386
                  echo "å®Œæˆ"

                  echo "[5/11] ç¼–è¯‘ Linux x64 (amd64)..."
                  GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-linux-amd64
                  echo "å®Œæˆ"

                  echo "[6/11] ç¼–è¯‘ Linux ARM (armv7)..."
                  GOOS=linux GOARCH=arm go build -ldflags="-s -w" -o build/flk-linux-arm
                  echo "å®Œæˆ"

                  echo "[7/11] ç¼–è¯‘ Linux ARM64..."
                  GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-linux-arm64
                  echo "å®Œæˆ"

                  # macOS (Darwin) (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[8/11] ç¼–è¯‘ macOS x64 (amd64)..."
                  GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-darwin-amd64
                  echo "å®Œæˆ"

                  echo "[9/11] ç¼–è¯‘ macOS ARM64 (Apple Silicon)..."
                  GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-darwin-arm64
                  echo "å®Œæˆ"

                  # FreeBSD (å¸¸ç”¨æ¶æ„)
                  echo ""
                  echo "[10/11] ç¼–è¯‘ FreeBSD x64 (amd64)..."
                  GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-freebsd-amd64
                  echo "å®Œæˆ"

                  echo "[11/11] ç¼–è¯‘ FreeBSD ARM64..."
                  GOOS=freebsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-freebsd-arm64
                  echo "å®Œæˆ"

                  # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
                  echo ""
                  echo "========================================"
                  echo "ç¼–è¯‘å®Œæˆï¼ç»Ÿè®¡ä¿¡æ¯ï¼š"
                  echo "========================================"
                  echo "æ€»æ–‡ä»¶æ•°: $(ls -1 build/ | wc -l)"
                  echo "æ€»å¤§å°: $(du -sh build/ | cut -f1)"

            - name: Find previous version tag
              id: previous_tag
              run: |
                  # è·å–å½“å‰æ ‡ç­¾
                  CURRENT_TAG="${{ steps.get_version.outputs.version }}"

                  # è·å–æ‰€æœ‰æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºï¼Œæ‰¾åˆ°å½“å‰æ ‡ç­¾ä¹‹å‰çš„æœ€æ–°æ ‡ç­¾
                  PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^$CURRENT_TAG$" | head -n1)

                  if [ -n "$PREVIOUS_TAG" ]; then
                    echo "Found previous tag: $PREVIOUS_TAG"
                    echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
                  else
                    echo "No previous tag found"
                    echo "previous_tag=" >> $GITHUB_OUTPUT
                  fi

            - name: Generate release notes
              id: release_notes
              run: |
                  CURRENT_TAG="${{ steps.get_version.outputs.version }}"
                  PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"

                  # å¿«é€Ÿä¸‹è½½è¡¨æ ¼
                  echo "## ğŸ“¥ å¿«é€Ÿä¸‹è½½" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "| æ¶æ„ | Windows | Linux | macOS | FreeBSD |" >> release_notes.md
                  echo "|------|---------|-------|-------|---------|" >> release_notes.md
                  echo "| **x86 (32ä½)** | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-386.exe) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-386) | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **x64 (64ä½)** | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-amd64.exe) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-darwin-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-amd64) |" >> release_notes.md
                  echo "| **ARM64** | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-arm64.exe) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-arm64) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-darwin-arm64) | [ARM64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-arm64) |" >> release_notes.md
                  echo "| **ARM (armv7)** | ä¸æ”¯æŒ | [ARM](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-arm) | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "> ğŸ’¡ **æç¤º**ï¼šWindows ç”¨æˆ·ä¸‹è½½ \`.exe\` æ–‡ä»¶ï¼Œå…¶ä»–ç³»ç»Ÿä¸‹è½½åéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ \`chmod +x flk-*\`" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md

                  # æ£€æŸ¥æ˜¯å¦æœ‰ CHANGELOG.md æ–‡ä»¶å¹¶æå–ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯
                  if [ -f "CHANGELOG.md" ]; then
                    echo "## æ›´æ–°å†…å®¹" >> release_notes.md
                    
                    # å°è¯•ä» CHANGELOG ä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
                    awk -v version="$CURRENT_TAG" '
                      /^##/ { 
                        if (found) exit
                        if ($0 ~ version) found=1
                        next
                      }
                      found && /^##/ { exit }
                      found { print }
                    ' CHANGELOG.md >> release_notes.md
                  fi

                  echo "## æäº¤è®°å½•" >> release_notes.md
                  echo "" >> release_notes.md

                  # ç”Ÿæˆæäº¤è®°å½•ï¼ˆæ’é™¤å¼€å‘ç‰ˆæœ¬ç›¸å…³çš„æäº¤ï¼‰
                  if [ -z "$PREVIOUS_TAG" ]; then
                    echo "ç”Ÿæˆä»åˆå§‹æäº¤åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
                    git log --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
                  else
                    echo "ç”Ÿæˆä» $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
                    git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
                  fi

                  # å¦‚æœæ²¡æœ‰æäº¤è®°å½•ï¼Œæ·»åŠ é»˜è®¤ä¿¡æ¯
                  if [ ! -s release_notes.md ] || [ $(wc -l < release_notes.md) -le 5 ]; then
                    echo "- ç‰ˆæœ¬å‘å¸ƒ" >> release_notes.md
                  fi

                  echo "" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "ğŸ“¦ **å®‰è£…è¯´æ˜ï¼š**" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "1. ä»ä¸Šæ–¹è¡¨æ ¼ä¸­é€‰æ‹©å¹¶ä¸‹è½½å¯¹åº”å¹³å°å’Œæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶" >> release_notes.md
                  echo "2. Linux/macOS/BSD ç”¨æˆ·éœ€è¦èµ‹äºˆæ‰§è¡Œæƒé™ï¼š\`chmod +x flk-*\`" >> release_notes.md
                  echo "3. åˆ›å»ºå¹¶é…ç½® \`config.json\` æ–‡ä»¶ï¼ˆå‚è€ƒ \`config.template.json\`ï¼‰" >> release_notes.md
                  echo "4. è¿è¡Œç¨‹åº" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/Jy-EggRoll/flk/blob/main/README.md)" >> release_notes.md

                  echo "ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ï¼š"
                  cat release_notes.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  name: "flk v${{ steps.get_version.outputs.version }}"
                  body_path: release_notes.md
                  files: |
                      build/*
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: binaries-${{ steps.get_version.outputs.version }}
                  path: build/*
                  retention-days: 90
