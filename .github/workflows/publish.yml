# è¯¥å·¥ä½œæµåªèƒ½é€šè¿‡æ­£å¼ç‰ˆæœ¬çš„æ ‡ç­¾è‡ªåŠ¨è§¦å‘

name: Publish Release

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+" # åŒ¹é… x.y.z æ ¼å¼çš„æ­£å¼ç‰ˆæœ¬æ ‡ç­¾

permissions:
    contents: write

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.26.0'

            - name: Get tag version
              id: get_version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION"

            - name: Build binaries for all platforms
              run: |
                  # åˆ›å»ºè¾“å‡ºç›®å½•
                  mkdir -p build

                  echo "========================================"
                  echo "å¼€å§‹äº¤å‰ç¼–è¯‘ Go äºŒè¿›åˆ¶æ–‡ä»¶"
                  echo "========================================"
                  echo ""

                  # Windows
                  echo "[1/33] ç¼–è¯‘ Windows 386..."
                  GOOS=windows GOARCH=386 go build -ldflags="-s -w" -o build/flk-windows-386.exe
                  echo "å®Œæˆ"

                  echo "[2/33] ç¼–è¯‘ Windows amd64..."
                  GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-windows-amd64.exe
                  echo "å®Œæˆ"

                  echo "[3/33] ç¼–è¯‘ Windows arm..."
                  GOOS=windows GOARCH=arm go build -ldflags="-s -w" -o build/flk-windows-arm.exe
                  echo "å®Œæˆ"

                  echo "[4/33] ç¼–è¯‘ Windows arm64..."
                  GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-windows-arm64.exe
                  echo "å®Œæˆ"

                  # Linux
                  echo ""
                  echo "[5/33] ç¼–è¯‘ Linux 386..."
                  GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o build/flk-linux-386
                  echo "å®Œæˆ"

                  echo "[6/33] ç¼–è¯‘ Linux amd64..."
                  GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-linux-amd64
                  echo "å®Œæˆ"

                  echo "[7/33] ç¼–è¯‘ Linux arm..."
                  GOOS=linux GOARCH=arm go build -ldflags="-s -w" -o build/flk-linux-arm
                  echo "å®Œæˆ"

                  echo "[8/33] ç¼–è¯‘ Linux arm64..."
                  GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-linux-arm64
                  echo "å®Œæˆ"

                  echo "[9/33] ç¼–è¯‘ Linux mips..."
                  GOOS=linux GOARCH=mips go build -ldflags="-s -w" -o build/flk-linux-mips
                  echo "å®Œæˆ"

                  echo "[10/33] ç¼–è¯‘ Linux mipsle..."
                  GOOS=linux GOARCH=mipsle go build -ldflags="-s -w" -o build/flk-linux-mipsle
                  echo "å®Œæˆ"

                  echo "[11/33] ç¼–è¯‘ Linux mips64..."
                  GOOS=linux GOARCH=mips64 go build -ldflags="-s -w" -o build/flk-linux-mips64
                  echo "å®Œæˆ"

                  echo "[12/33] ç¼–è¯‘ Linux mips64le..."
                  GOOS=linux GOARCH=mips64le go build -ldflags="-s -w" -o build/flk-linux-mips64le
                  echo "å®Œæˆ"

                  echo "[13/33] ç¼–è¯‘ Linux ppc64..."
                  GOOS=linux GOARCH=ppc64 go build -ldflags="-s -w" -o build/flk-linux-ppc64
                  echo "å®Œæˆ"

                  echo "[14/33] ç¼–è¯‘ Linux ppc64le..."
                  GOOS=linux GOARCH=ppc64le go build -ldflags="-s -w" -o build/flk-linux-ppc64le
                  echo "å®Œæˆ"

                  echo "[15/33] ç¼–è¯‘ Linux riscv64..."
                  GOOS=linux GOARCH=riscv64 go build -ldflags="-s -w" -o build/flk-linux-riscv64
                  echo "å®Œæˆ"

                  echo "[16/33] ç¼–è¯‘ Linux s390x..."
                  GOOS=linux GOARCH=s390x go build -ldflags="-s -w" -o build/flk-linux-s390x
                  echo "å®Œæˆ"

                  # macOS (Darwin)
                  echo ""
                  echo "[17/33] ç¼–è¯‘ macOS amd64..."
                  GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-darwin-amd64
                  echo "å®Œæˆ"

                  echo "[18/33] ç¼–è¯‘ macOS arm64 (Apple Silicon)..."
                  GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-darwin-arm64
                  echo "å®Œæˆ"

                  # FreeBSD
                  echo ""
                  echo "[19/33] ç¼–è¯‘ FreeBSD 386..."
                  GOOS=freebsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-freebsd-386
                  echo "å®Œæˆ"

                  echo "[20/33] ç¼–è¯‘ FreeBSD amd64..."
                  GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-freebsd-amd64
                  echo "å®Œæˆ"

                  echo "[21/33] ç¼–è¯‘ FreeBSD arm..."
                  GOOS=freebsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-freebsd-arm
                  echo "å®Œæˆ"

                  echo "[22/33] ç¼–è¯‘ FreeBSD arm64..."
                  GOOS=freebsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-freebsd-arm64
                  echo "å®Œæˆ"

                  # OpenBSD
                  echo ""
                  echo "[23/33] ç¼–è¯‘ OpenBSD 386..."
                  GOOS=openbsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-openbsd-386
                  echo "å®Œæˆ"

                  echo "[24/33] ç¼–è¯‘ OpenBSD amd64..."
                  GOOS=openbsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-openbsd-amd64
                  echo "å®Œæˆ"

                  echo "[25/33] ç¼–è¯‘ OpenBSD arm..."
                  GOOS=openbsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-openbsd-arm
                  echo "å®Œæˆ"

                  echo "[26/33] ç¼–è¯‘ OpenBSD arm64..."
                  GOOS=openbsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-openbsd-arm64
                  echo "å®Œæˆ"

                  # NetBSD
                  echo ""
                  echo "[27/33] ç¼–è¯‘ NetBSD 386..."
                  GOOS=netbsd GOARCH=386 go build -ldflags="-s -w" -o build/flk-netbsd-386
                  echo "å®Œæˆ"

                  echo "[28/33] ç¼–è¯‘ NetBSD amd64..."
                  GOOS=netbsd GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-netbsd-amd64
                  echo "å®Œæˆ"

                  echo "[29/33] ç¼–è¯‘ NetBSD arm..."
                  GOOS=netbsd GOARCH=arm go build -ldflags="-s -w" -o build/flk-netbsd-arm
                  echo "å®Œæˆ"

                  echo "[30/33] ç¼–è¯‘ NetBSD arm64..."
                  GOOS=netbsd GOARCH=arm64 go build -ldflags="-s -w" -o build/flk-netbsd-arm64
                  echo "å®Œæˆ"

                  # DragonFly BSD
                  echo ""
                  echo "[31/33] ç¼–è¯‘ DragonFly BSD amd64..."
                  GOOS=dragonfly GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-dragonfly-amd64
                  echo "å®Œæˆ"

                  # Solaris
                  echo ""
                  echo "[32/33] ç¼–è¯‘ Solaris amd64..."
                  GOOS=solaris GOARCH=amd64 go build -ldflags="-s -w" -o build/flk-solaris-amd64
                  echo "å®Œæˆ"

                  # AIX
                  echo ""
                  echo "[33/33] ç¼–è¯‘ AIX ppc64..."
                  GOOS=aix GOARCH=ppc64 go build -ldflags="-s -w" -o build/flk-aix-ppc64
                  echo "å®Œæˆ"

                  # æ˜¾ç¤ºç¼–è¯‘ç»“æœ
                  echo ""
                  echo "========================================"
                  echo "ç¼–è¯‘å®Œæˆï¼ç»Ÿè®¡ä¿¡æ¯ï¼š"
                  echo "========================================"
                  echo "æ€»æ–‡ä»¶æ•°: $(ls -1 build/ | wc -l)"
                  echo "æ€»å¤§å°: $(du -sh build/ | cut -f1)"

            - name: Find previous version tag
              id: previous_tag
              run: |
                  # è·å–å½“å‰æ ‡ç­¾
                  CURRENT_TAG="${{ steps.get_version.outputs.version }}"

                  # è·å–æ‰€æœ‰æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºï¼Œæ‰¾åˆ°å½“å‰æ ‡ç­¾ä¹‹å‰çš„æœ€æ–°æ ‡ç­¾
                  PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^$CURRENT_TAG$" | head -n1)

                  if [ -n "$PREVIOUS_TAG" ]; then
                    echo "Found previous tag: $PREVIOUS_TAG"
                    echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
                  else
                    echo "No previous tag found"
                    echo "previous_tag=" >> $GITHUB_OUTPUT
                  fi

            - name: Generate release notes
              id: release_notes
              run: |
                  CURRENT_TAG="${{ steps.get_version.outputs.version }}"
                  PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"

                  # å¿«é€Ÿä¸‹è½½è¡¨æ ¼
                  echo "## ğŸ“¥ å¿«é€Ÿä¸‹è½½" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "| æ¶æ„ | Windows | Linux | macOS | FreeBSD | OpenBSD | NetBSD | å…¶ä»– |" >> release_notes.md
                  echo "|------|---------|-------|-------|---------|---------|--------|------|" >> release_notes.md
                  echo "| **x64** | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-amd64.exe) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-darwin-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-openbsd-amd64) | [x64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-netbsd-amd64) | [Solaris](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-solaris-amd64) |" >> release_notes.md
                  echo "| **ARM64** | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-arm64.exe) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-darwin-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-openbsd-arm64) | [arm64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-netbsd-arm64) | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **x86** | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-386.exe) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-386) | ä¸æ”¯æŒ | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-386) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-openbsd-386) | [x86](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-netbsd-386) | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **ARM** | [arm](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-windows-arm.exe) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-arm) | ä¸æ”¯æŒ | [arm](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-freebsd-arm) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-openbsd-arm) | [arm](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-netbsd-arm) | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **MIPS** | ä¸æ”¯æŒ | [mips](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-mips) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **MIPSle** | ä¸æ”¯æŒ | [mipsle](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-mipsle) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **MIPS64** | ä¸æ”¯æŒ | [mips64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-mips64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **MIPS64le** | ä¸æ”¯æŒ | [mips64le](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-mips64le) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **PPC64** | ä¸æ”¯æŒ | [ppc64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-ppc64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | [AIX](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-aix-ppc64) |" >> release_notes.md
                  echo "| **PPC64le** | ä¸æ”¯æŒ | [ppc64le](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-ppc64le) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **RISC-V 64** | ä¸æ”¯æŒ | [riscv64](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-riscv64) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ |" >> release_notes.md
                  echo "| **S390X** | ä¸æ”¯æŒ | [s390x](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-linux-s390x) | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | ä¸æ”¯æŒ | [DragonFly](https://github.com/Jy-EggRoll/flk/releases/download/$CURRENT_TAG/flk-dragonfly-amd64) |" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "> ğŸ’¡ **æç¤º**ï¼šWindows ç”¨æˆ·ä¸‹è½½ \`.exe\` æ–‡ä»¶ï¼Œå…¶ä»–ç³»ç»Ÿä¸‹è½½åéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ \`chmod +x flk-*\`" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md

                  # æ£€æŸ¥æ˜¯å¦æœ‰ CHANGELOG.md æ–‡ä»¶å¹¶æå–ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯
                  if [ -f "CHANGELOG.md" ]; then
                    echo "## æ›´æ–°å†…å®¹" >> release_notes.md
                    
                    # å°è¯•ä» CHANGELOG ä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
                    awk -v version="$CURRENT_TAG" '
                      /^##/ { 
                        if (found) exit
                        if ($0 ~ version) found=1
                        next
                      }
                      found && /^##/ { exit }
                      found { print }
                    ' CHANGELOG.md >> release_notes.md
                  fi

                  echo "## æäº¤è®°å½•" >> release_notes.md
                  echo "" >> release_notes.md

                  # ç”Ÿæˆæäº¤è®°å½•ï¼ˆæ’é™¤å¼€å‘ç‰ˆæœ¬ç›¸å…³çš„æäº¤ï¼‰
                  if [ -z "$PREVIOUS_TAG" ]; then
                    echo "ç”Ÿæˆä»åˆå§‹æäº¤åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
                    git log --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
                  else
                    echo "ç”Ÿæˆä» $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
                    git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
                  fi

                  # å¦‚æœæ²¡æœ‰æäº¤è®°å½•ï¼Œæ·»åŠ é»˜è®¤ä¿¡æ¯
                  if [ ! -s release_notes.md ] || [ $(wc -l < release_notes.md) -le 5 ]; then
                    echo "- ç‰ˆæœ¬å‘å¸ƒ" >> release_notes.md
                  fi

                  echo "" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "---" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "ğŸ“¦ **å®‰è£…è¯´æ˜ï¼š**" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "1. ä»ä¸Šæ–¹è¡¨æ ¼ä¸­é€‰æ‹©å¹¶ä¸‹è½½å¯¹åº”å¹³å°å’Œæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶" >> release_notes.md
                  echo "2. Linux/macOS/BSD ç”¨æˆ·éœ€è¦èµ‹äºˆæ‰§è¡Œæƒé™ï¼š\`chmod +x flk-*\`" >> release_notes.md
                  echo "3. åˆ›å»ºå¹¶é…ç½® \`config.json\` æ–‡ä»¶ï¼ˆå‚è€ƒ \`config.template.json\`ï¼‰" >> release_notes.md
                  echo "4. è¿è¡Œç¨‹åº" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/Jy-EggRoll/flk/blob/main/README.md)" >> release_notes.md

                  echo "ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ï¼š"
                  cat release_notes.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  name: "flk v${{ steps.get_version.outputs.version }}"
                  body_path: release_notes.md
                  files: |
                      build/*
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: binaries-${{ steps.get_version.outputs.version }}
                  path: build/*
                  retention-days: 90
